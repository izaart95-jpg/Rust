name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Download nircmd
        run: |
          Write-Host "Downloading nircmd..."
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd.zip"
          $zipPath = "$env:TEMP\nircmd.zip"
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath "$env:TEMP\nircmd_extract" -Force
          $nircmdExe = Get-ChildItem -Path "$env:TEMP\nircmd_extract" -Filter "nircmd.exe" -Recurse | Select-Object -First 1
          if ($nircmdExe) {
              Copy-Item -Path $nircmdExe.FullName -Destination "$env:WORK_DIR\nircmd.exe" -Force
              Write-Host "nircmd downloaded successfully"
          }

      - name: Download and install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec silently..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Start Parsec
        run: |
          Write-Host "Starting Parsec..."
          
          # Start Parsec
          $parsecExePath = "C:\Program Files\Parsec\parsecd.exe"
          if (Test-Path $parsecExePath) {
              Start-Process $parsecExePath
              Write-Host "Parsec started..."
          }
          
          Start-Sleep -Seconds 10

      - name: Take reference screenshot
        run: |
          Write-Host "Taking reference screenshot..."
          
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\login_screen.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          
          Write-Host "Screen resolution: $($bounds.Width)x$($bounds.Height)"

      - name: Method 1 Click top then bottom
        run: |
          Write-Host "=== METHOD 1: SIMPLE CLICK APPROACH ==="
          
          # Get screen dimensions
          Add-Type -AssemblyName System.Windows.Forms
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $width = $screen.Bounds.Width
          $height = $screen.Bounds.Height
          $centerX = [math]::Round($width / 2)
          
          Write-Host "Screen: ${width}x${height}"
          Write-Host "Center X: $centerX"
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              # CLEAN SLATE: Click somewhere safe first to clear any selections
              Write-Host "Clearing any selections..."
              & "$env:WORK_DIR\nircmd.exe" setcursor 100 100
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              Start-Sleep -Seconds 1
              
              # STEP 1: CLICK TOP FIELD (EMAIL)
              $topY = [math]::Round($height * 0.4)  # 40% from top
              Write-Host "Step 1: Clicking top field at $centerX, $topY"
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $topY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # TYPE EMAIL ONLY
              Add-Type -AssemblyName System.Windows.Forms
              Write-Host "Typing email ONLY..."
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
              Start-Sleep -Seconds 1
              
              # Screenshot after email
              Add-Type -AssemblyName System.Drawing
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\method1_after_email.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # STEP 2: CLICK BOTTOM FIELD (PASSWORD)
              $bottomY = [math]::Round($height * 0.5)  # 50% from top
              Write-Host "Step 2: Clicking bottom field at $centerX, $bottomY"
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $bottomY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # TYPE PASSWORD ONLY
              Write-Host "Typing password ONLY..."
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
              Start-Sleep -Seconds 1
              
              # Screenshot after password
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\method1_after_password.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # STEP 3: CLICK LOGIN BUTTON (even lower)
              $loginY = [math]::Round($height * 0.6)  # 60% from top
              Write-Host "Step 3: Clicking login button at $centerX, $loginY"
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $loginY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              Start-Sleep -Seconds 2
              
              Write-Host "Method 1 completed"
          }

      - name: Method 2 Tab navigation only
        run: |
          Write-Host "=== METHOD 2: TAB NAVIGATION ONLY ==="
          Start-Sleep -Seconds 3
          
          # First, click to focus the window
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Add-Type -AssemblyName System.Windows.Forms
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $width = $screen.Bounds.Width
              $height = $screen.Bounds.Height
              
              Write-Host "Focusing window..."
              & "$env:WORK_DIR\nircmd.exe" setcursor ([math]::Round($width/2)) ([math]::Round($height/2))
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              Start-Sleep -Seconds 1
              
              # Send Ctrl+A to select all in current field
              [System.Windows.Forms.SendKeys]::SendWait("^a")
              Start-Sleep -Milliseconds 200
              
              # If text is selected, delete it (this means we're in a field)
              [System.Windows.Forms.SendKeys]::SendWait("{DELETE}")
              Start-Sleep -Milliseconds 500
              
              # Type email
              Write-Host "Typing email..."
              [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
              Start-Sleep -Seconds 1
              
              # Screenshot
              Add-Type -AssemblyName System.Drawing
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\method2_after_email.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # Tab to next field
              Write-Host "Tabbing to next field..."
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
              Start-Sleep -Seconds 1
              
              # Clear and type password
              Write-Host "Typing password..."
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
              Start-Sleep -Seconds 1
              
              # Screenshot
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\method2_after_password.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # Tab to login button and press Enter
              Write-Host "Submitting..."
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
              
              Write-Host "Method 2 completed"
          }

      - name: Method 3 Manual field discovery
        run: |
          Write-Host "=== METHOD 3: MANUAL FIELD DISCOVERY ==="
          Start-Sleep -Seconds 3
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $width = $screen.Bounds.Width
              $height = $screen.Bounds.Height
              $centerX = [math]::Round($width / 2)
              
              Write-Host "Testing which field is which..."
              
              # Test 1: Click near top and type EMAILTEST
              $testY1 = [math]::Round($height * 0.35)
              Write-Host "Test 1: Clicking at $centerX, $testY1"
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $testY1
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}EMAILTEST")
              Start-Sleep -Seconds 1
              
              # Screenshot test 1
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\test1_emailtest.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # Test 2: Click lower and type PASSTEST
              $testY2 = [math]::Round($height * 0.45)
              Write-Host "Test 2: Clicking at $centerX, $testY2"
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $testY2
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}PASSTEST")
              Start-Sleep -Seconds 1
              
              # Screenshot test 2
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\test2_passtest.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # Now based on screenshots, we can see which is email vs password
              Write-Host "Check screenshots to see which field is which"
              Write-Host "test1_emailtest.png - Should show EMAILTEST in plain text (email field)"
              Write-Host "test2_passtest.png - Should show asterisks (password field)"
              
              # Clear everything for final attempt
              Write-Host "Clearing for final attempt..."
              
              # Clear first field
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $testY1
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Milliseconds 500
              
              # Clear second field
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $testY2
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Seconds 1
          }

      - name: Final attempt based on discovery
        run: |
          Write-Host "=== FINAL ATTEMPT ==="
          Start-Sleep -Seconds 3
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $width = $screen.Bounds.Width
              $height = $screen.Bounds.Height
              $centerX = [math]::Round($width / 2)
              
              # Based on test screenshots, use the correct Y positions
              # Default: top field is email, bottom field is password
              $emailY = [math]::Round($height * 0.35)
              $passwordY = [math]::Round($height * 0.45)
              $loginY = [math]::Round($height * 0.55)
              
              Write-Host "Final attempt with coordinates:"
              Write-Host "Email: $centerX, $emailY"
              Write-Host "Password: $centerX, $passwordY"
              Write-Host "Login: $centerX, $loginY"
              
              # Email field
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $emailY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
              Start-Sleep -Seconds 1
              
              # Password field
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $passwordY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
              Start-Sleep -Seconds 1
              
              # Login button
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $loginY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              Start-Sleep -Seconds 2
              
              Write-Host "Final attempt completed"
          }

      - name: Take final screenshots
        run: |
          Write-Host "=== FINAL RESULTS ==="
          Start-Sleep -Seconds 5
          
          # Take final screenshots
          for ($i = 1; $i -le 3; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              
              $fileName = "final_$i.png"
              $bitmap.Save("$env:WORK_DIR\$fileName", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              Write-Host "Final screenshot $i taken"
              Start-Sleep -Seconds 1
          }
          
          # Check Parsec
          $parsecProcess = Get-Process | Where-Object { $_.ProcessName -like "*parsec*" }
          Write-Host "Parsec processes:"
          $parsecProcess | Format-Table ProcessName, Id, MainWindowTitle -AutoSize

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: parsec-results
          path: D:\a\SEB\SEB\parsec\
          retention-days: 1
