name: PS

on:
  workflow_dispatch:

jobs:
  execute:
    runs-on: windows-latest
    timeout-minutes: 140

    steps:
      - name: Setup Environment
        shell: powershell
        run: |
          function Decode-B64 {
              param([string]$input)
              return [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($input))
          }

          $parsecUrl = Decode-B64 'aHR0cHM6Ly9idWlsZHMucGFyc2VjLmFwcC9wYWNrYWdlL3BhcnNlYy13aW5kb3dzLmV4ZQ=='
          $ahkUrl = Decode-B64 'aHR0cHM6Ly93d3cuYXV0b2hvdGtleS5jb20vZG93bmxvYWQvYW5rLWluc3RhbGwuZXhl'
          $email = Decode-B64 'ZmZiZXdhZmE3MDlAZ21haWwuY29t'
          $password = Decode-B64 'SGFtemFAMTIzNDU2'

          $workDir = "$env:TEMP\parsec_" + (Get-Date -Format "yyyyMMdd_HHmmss")
          New-Item -ItemType Directory -Path $workDir -Force | Out-Null

          echo "WORK_DIR=$workDir"     >> $env:GITHUB_ENV
          echo "EMAIL=$email"          >> $env:GITHUB_ENV
          echo "PASSWORD=$password"    >> $env:GITHUB_ENV

      - name: Download and Install Software
        shell: powershell
        run: |
          $parsecInstaller = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri "https://builds.parsec.app/package/parsec-windows.exe" -OutFile $parsecInstaller

          $ahkInstaller = "$env:WORK_DIR\autohotkey.exe"
          Invoke-WebRequest -Uri "https://www.autohotkey.com/download/ahk-install.exe" -OutFile $ahkInstaller

          Start-Process $parsecInstaller -ArgumentList "/S /AllUsers" -Wait
          Start-Process $ahkInstaller -ArgumentList "/S" -Wait

      - name: Start Parsec
        shell: powershell
        run: |
          $parsecPath = "$env:ProgramFiles\Parsec\parsecd.exe"
          if (!(Test-Path $parsecPath)) {
              $parsecPath = "${env:ProgramFiles(x86)}\Parsec\parsecd.exe"
          }
          if (Test-Path $parsecPath) {
              Start-Process -FilePath $parsecPath -WindowStyle Minimized
          }
          Start-Sleep -Seconds 15

      - name: Create Automation Script
        shell: powershell
        run: |
          $ahkScript = @'
#NoTrayIcon
SetTitleMatchMode, 2
WinWait, Parsec,, 45
Sleep, 8000
Send, {Tab}
Sleep, 1500
Send, %EMAIL%
Sleep, 1500
Send, {Tab}
Sleep, 1500
Send, %PASSWORD%
Sleep, 1500
Send, {Tab}
Send, {Tab}
Send, {Enter}
MsgBox, 64, Action Required, Complete 2FA then press OK.
Sleep, 15000
Send, {F5}
Loop, 20 {
    Sleep, 10000
}
ExitApp
'@

          $scriptPath = "$env:WORK_DIR\automation.ahk"
          Set-Content -Path $scriptPath -Value $ahkScript
          echo "SCRIPT_PATH=$scriptPath" >> $env:GITHUB_ENV

      - name: Run Automation
        shell: powershell
        run: |
          $ahkPath = "$env:ProgramFiles\AutoHotkey\AutoHotkey.exe"
          if (!(Test-Path $ahkPath)) {
              $ahkPath = "${env:ProgramFiles(x86)}\AutoHotkey\AutoHotkey.exe"
          }
          Start-Process -FilePath $ahkPath -ArgumentList $env:SCRIPT_PATH -WindowStyle Hidden
          Start-Sleep -Seconds 30

      - name: Monitor and Keep Alive
        shell: powershell
        run: |
          $start = Get-Date
          while ((New-TimeSpan -Start $start -End (Get-Date)).TotalHours -lt 24) {
              Start-Sleep -Seconds 300
          }

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parsec-screenshots
          path: ${{ env.WORK_DIR }}/*.png
          retention-days: 1

      - name: Cleanup
        if: always()
        shell: powershell
        run: |
          Get-Process -Name "parsecd","Parsec","AutoHotkey" -ErrorAction SilentlyContinue | Stop-Process -Force
