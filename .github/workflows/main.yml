name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Download nircmd
        run: |
          Write-Host "Downloading nircmd..."
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd.zip"
          $zipPath = "$env:TEMP\nircmd.zip"
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath "$env:TEMP\nircmd_extract" -Force
          $nircmdExe = Get-ChildItem -Path "$env:TEMP\nircmd_extract" -Filter "nircmd.exe" -Recurse | Select-Object -First 1
          if ($nircmdExe) {
              Copy-Item -Path $nircmdExe.FullName -Destination "$env:WORK_DIR\nircmd.exe" -Force
              Write-Host "nircmd downloaded successfully"
          }

      - name: Download and install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec silently..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Start Parsec
        run: |
          Write-Host "Starting Parsec..."
          
          # Start Parsec
          $parsecExePath = "C:\Program Files\Parsec\parsecd.exe"
          if (Test-Path $parsecExePath) {
              Start-Process $parsecExePath
              Write-Host "Parsec started..."
          }
          
          Start-Sleep -Seconds 10

      - name: Take initial screenshot
        run: |
          Write-Host "Taking initial screenshot..."
          
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\initial.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          
          Write-Host "Screen resolution: $($bounds.Width)x$($bounds.Height)"

      - name: SMART APPROACH - Find Parsec window first
        run: |
          Write-Host "=== SMART APPROACH: Find Parsec window ==="
          Write-Host "Problem: Parsec window is NOT fullscreen"
          Write-Host "Solution: We need to find the window position first"
          
          # First, let's find the Parsec window
          Add-Type -AssemblyName System.Windows.Forms
          
          # Take a fresh screenshot to see window position
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $width = $bounds.Width
          $height = $bounds.Height
          
          Write-Host "Looking for Parsec window on screen..."
          
          # Create a simple method: Click around the center area to find window
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Write-Host "Searching for Parsec window by clicking around center..."
              
              # Define search area (center of screen)
              $centerX = [math]::Round($width / 2)
              $centerY = [math]::Round($height / 2)
              
              # Click at center to activate window
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $centerY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              Start-Sleep -Seconds 1
              
              # Now try to find fields RELATIVE to window
              # Since window is smaller, we need to click INSIDE the window
              
              # METHOD 1: Use TAB navigation within the window
              Write-Host "=== METHOD 1: TAB NAVIGATION ==="
              
              # Press Tab a few times to get to first field
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
              Start-Sleep -Seconds 1
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
              Start-Sleep -Seconds 1
              
              # Should be in email field now
              Write-Host "Should be in email field - typing email"
              [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
              Start-Sleep -Seconds 1
              
              # Tab to password field
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
              Start-Sleep -Seconds 1
              
              # Type password
              Write-Host "Should be in password field - typing password"
              [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
              Start-Sleep -Seconds 1
              
              # Tab to login button and press Enter
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
              Start-Sleep -Seconds 2
              
              # Screenshot after method 1
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\method1_tab.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
          }

      - name: METHOD 2 - Manual click in window center
        run: |
          Write-Host "=== METHOD 2: MANUAL CLICK IN WINDOW ==="
          Start-Sleep -Seconds 5
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $width = $screen.Bounds.Width
              $height = $screen.Bounds.Height
              
              # Window is likely centered, so click around center
              $centerX = [math]::Round($width / 2)
              
              # Since window is smaller, we need to click higher in the window
              # Try clicking at different Y positions within the window
              
              Write-Host "Trying clicks at different positions in window..."
              
              # Try a grid of clicks within window area
              $startY = [math]::Round($height * 0.4)  # Start at 40% from top
              $endY = [math]::Round($height * 0.7)    # End at 70% from top
              $step = 20  # 20 pixel steps
              
              for ($y = $startY; $y -le $endY; $y += $step) {
                  Write-Host "Clicking at $centerX, $y"
                  
                  # Double click to select field
                  & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $y
                  Start-Sleep -Milliseconds 300
                  & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
                  Start-Sleep -Seconds 1
                  
                  # Type "TEST" to see which field we're in
                  [System.Windows.Forms.SendKeys]::SendWait("TEST")
                  Start-Sleep -Seconds 1
                  
                  # Clear it
                  [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
                  Start-Sleep -Milliseconds 500
                  
                  # Screenshot for this position
                  $bitmap = New-Object System.Drawing.Bitmap($width, $height)
                  $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
                  $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
                  $bitmap.Save("$env:WORK_DIR\test_y_${y}.png", [System.Drawing.Imaging.ImageFormat]::Png)
                  $graphics.Dispose()
                  $bitmap.Dispose()
                  
                  Write-Host "Tested Y=$y, check screenshot test_y_${y}.png"
              }
              
              # Based on screenshots, we'll know which Y is email vs password
              Write-Host "Check the test_y_*.png screenshots"
              Write-Host "Look for 'TEST' in plain text (email field) or asterisks (password field)")
          }

      - name: METHOD 3 - Use discovered positions
        run: |
          Write-Host "=== METHOD 3: USE DISCOVERED POSITIONS ==="
          Start-Sleep -Seconds 5
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Add-Type -AssemblyName System.Windows.Forms
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $width = $screen.Bounds.Width
              $height = $screen.Bounds.Height
              $centerX = [math]::Round($width / 2)
              
              # Based on the test screenshots, we'll know:
              # - Which Y shows "TEST" in plain text (email field)
              # - Which Y shows asterisks (password field)
              
              # Default guesses for smaller window:
              # Email field might be around 45% from top
              # Password field around 55% from top
              # Login button around 65% from top
              
              $emailY = [math]::Round($height * 0.45)
              $passwordY = [math]::Round($height * 0.55)
              $loginY = [math]::Round($height * 0.65)
              
              Write-Host "Trying with positions for smaller window:"
              Write-Host "Email: $centerX, $emailY"
              Write-Host "Password: $centerX, $passwordY"
              Write-Host "Login: $centerX, $loginY"
              
              # Clear any existing text first
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $emailY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Milliseconds 500
              
              # Type email
              [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
              Start-Sleep -Seconds 1
              
              # Click password field
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $passwordY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Milliseconds 500
              
              # Type password
              [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
              Start-Sleep -Seconds 1
              
              # Click login button
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $loginY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              Start-Sleep -Seconds 2
              
              # Also try Enter key
              [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
              Start-Sleep -Seconds 2
          }

      - name: METHOD 4 - Simple but reliable
        run: |
          Write-Host "=== METHOD 4: SIMPLE BUT RELIABLE ==="
          Write-Host "Strategy: Click top, type email, press Tab, type password, press Enter"
          Start-Sleep -Seconds 5
          
          Add-Type -AssemblyName System.Windows.Forms
          
          # Simple approach:
          # 1. Click near top center (should hit email field)
          # 2. Type email
          # 3. Press Tab (should go to password)
          # 4. Type password
          # 5. Press Enter
          
          Write-Host "Step 1: Clicking near top center...")
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $width = $screen.Bounds.Width
              $height = $screen.Bounds.Height
              
              $clickX = [math]::Round($width / 2)
              $clickY = [math]::Round($height * 0.4)  # 40% from top
              
              & "$env:WORK_DIR\nircmd.exe" setcursor $clickX $clickY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
          }
          
          Write-Host "Step 2: Typing email...")
          [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}ffbewafa709@gmail.com")
          Start-Sleep -Seconds 1
          
          Write-Host "Step 3: Pressing Tab to go to password field...")
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Seconds 1
          
          Write-Host "Step 4: Typing password...")
          [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
          Start-Sleep -Seconds 1
          
          Write-Host "Step 5: Pressing Enter to login...")
          [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
          Start-Sleep -Seconds 2
          
          # Try Tab then Enter as backup
          Write-Host "Step 6: Trying Tab then Enter as backup...")
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Milliseconds 500
          [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
          Start-Sleep -Seconds 2

      - name: Take final screenshots
        run: |
          Write-Host "=== FINAL RESULTS ==="
          Start-Sleep -Seconds 8
          
          # Take final screenshots
          for ($i = 1; $i -le 3; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              
              $fileName = "final_$i.png"
              $bitmap.Save("$env:WORK_DIR\$fileName", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              Write-Host "Final screenshot $i taken"
              Start-Sleep -Seconds 1
          }
          
          # Check Parsec
          $parsecProcess = Get-Process | Where-Object { $_.ProcessName -like "*parsec*" }
          Write-Host "=== PARSEC STATUS ==="
          if ($parsecProcess) {
              Write-Host "✓ Parsec is running"
              $parsecProcess | Format-Table ProcessName, Id, MainWindowTitle -AutoSize
          } else {
              Write-Host "✗ Parsec is NOT running"
          }

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: parsec-results
          path: D:\a\SEB\SEB\parsec\
          retention-days: 1
