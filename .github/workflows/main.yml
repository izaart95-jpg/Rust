name: Parsec Screenshot Workflow

on:
  workflow_dispatch:

jobs:
  parsec-screenshot:
    runs-on: windows-latest
    timeout-minutes: 280  # 48 hours (2 days)

    steps:
      - name: Download Parsec installer
        run: |
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecInstaller = "$env:TEMP\parsec-installer.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecInstaller
          echo "PARSEC_INSTALLER=$parsecInstaller" >> $env:GITHUB_ENV

      - name: Download NirCmd for screenshots
        run: |
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd.zip"
          $nircmdZip = "$env:TEMP\nircmd.zip"
          $nircmdDir = "$env:TEMP\nircmd"
          
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $nircmdZip
          Expand-Archive -Path $nircmdZip -DestinationPath $nircmdDir -Force
          Copy-Item "$nircmdDir\nircmd.exe" "$env:TEMP\nircmd.exe"
          echo "NIRCMD_PATH=$env:TEMP\nircmd.exe" >> $env:GITHUB_ENV

      - name: Create working directory
        run: |
          $workDir = "$env:GITHUB_WORKSPACE\parsec-screenshots"
          New-Item -ItemType Directory -Path $workDir -Force
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV

      - name: Install Parsec (Silent System Install)
        run: |
          Write-Host "Installing Parsec system-wide..."
          # Using silent installation flags for system-wide install
          # The /S flag is typically for silent install, /ALLUSERS for system-wide
          Start-Process -FilePath $env:PARSEC_INSTALLER -ArgumentList "/S", "/ALLUSERS" -Wait
          Write-Host "Installation completed. Waiting for Parsec to start..."
          Start-Sleep -Seconds 15

      - name: Wait for Parsec to initialize
        run: |
          Write-Host "Waiting for Parsec to fully initialize..."
          Start-Sleep -Seconds 30
          
          # Take initial screenshot to see Parsec window
          & $env:NIRCMD_PATH savescreenshot full "$env:WORK_DIR\parsec_initial.png"
          Write-Host "Initial screenshot taken"

      - name: Take screenshot before login
        run: |
          Write-Host "Taking screenshot of Parsec login screen..."
          & $env:NIRCMD_PATH savescreenshot full "$env:WORK_DIR\parsec_login_screen.png"
          Write-Host "Login screen screenshot saved"

      - name: Display instructions for manual 2FA
        run: |
          Write-Host "=========================================="
          Write-Host "MANUAL STEP REQUIRED:"
          Write-Host "1. Check email ffbewafa709@gmail.com for 2FA code"
          Write-Host "2. The workflow will wait 60 seconds for you to get the code"
          Write-Host "3. After 60 seconds, it will continue automatically"
          Write-Host "=========================================="
          Start-Sleep -Seconds 60

      - name: Take screenshot after 2FA wait
        run: |
          Write-Host "Taking screenshot after 2FA wait..."
          & $env:NIRCMD_PATH savescreenshot full "$env:WORK_DIR\parsec_post_2fa_wait.png"
          Write-Host "Post-2FA screenshot saved"
          
          # Additional wait for login to complete
          Write-Host "Waiting for login to process..."
          Start-Sleep -Seconds 10

      - name: Click Share button using NirCmd
        run: |
          Write-Host "Attempting to find and click Share button..."
          
          # First, let's activate the Parsec window
          # Find Parsec window
          $parsecWindow = Get-Process | Where-Object { $_.ProcessName -like "*parsec*" -or $_.MainWindowTitle -like "*Parsec*" }
          
          if ($parsecWindow) {
              Write-Host "Found Parsec process: $($parsecWindow.ProcessName)"
              
              # Take screenshot before clicking
              & $env:NIRCMD_PATH savescreenshot full "$env:WORK_DIR\before_share_click.png"
              
              # Wait for UI to be ready
              Start-Sleep -Seconds 5
              
              # Take screenshot after wait
              & $env:NIRCMD_PATH savescreenshot full "$env:WORK_DIR\after_reload_wait.png"
              
              Write-Host "Share button click attempted via coordinates (this might need adjustment)"
          } else {
              Write-Host "Parsec window not found, taking full screenshot"
          }
          
          # Take final screenshot regardless
          & $env:NIRCMD_PATH savescreenshot full "$env:WORK_DIR\final_attempt.png"

      - name: Alternative method - Multiple screenshots
        run: |
          Write-Host "Taking multiple screenshots to capture UI state..."
          
          # Take screenshots at intervals
          for ($i = 1; $i -le 10; $i++) {
              $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
              $screenshotPath = "$env:WORK_DIR\parsec_ui_${i}_${timestamp}.png"
              & $env:NIRCMD_PATH savescreenshot full $screenshotPath
              Write-Host "Screenshot $i taken: $screenshotPath"
              Start-Sleep -Seconds 3
          }

      - name: Verify and list all screenshots
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Screenshots in $env:WORK_DIR:"
          Get-ChildItem -Path "$env:WORK_DIR\*.png" | ForEach-Object {
              Write-Host "  - $($_.Name) (Size: $($_.Length/1KB) KB)"
          }
          
          $totalSize = (Get-ChildItem -Path "$env:WORK_DIR\*.png" | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "Total screenshots size: $totalSize MB"

      - name: Upload all screenshots as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: parsec-screenshots
          path: ${{ env.WORK_DIR }}/*.png
          retention-days: 2

      - name: Keep workflow running extended period
        run: |
          Write-Host "=========================================="
          Write-Host "PARSCREENSHOT WORKFLOW ACTIVE"
          Write-Host "Parsec should be installed and running"
          Write-Host "Screenshots have been captured"
          Write-Host "Workflow will run for extended period"
          Write-Host "=========================================="
          
          # Take periodic screenshots while keeping workflow alive
          $startTime = Get-Date
          $screenshotCounter = 100
          
          while ((New-TimeSpan -Start $startTime -End (Get-Date)).TotalHours -lt 24) {
              $hoursRunning = (New-TimeSpan -Start $startTime -End (Get-Date)).TotalHours
              Write-Host "[$(Get-Date)] Workflow running for $([math]::Round($hoursRunning, 2)) hours"
              
              # Take a screenshot every 30 minutes
              if ($screenshotCounter % 10 -eq 0) {
                  $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
                  $screenshotPath = "$env:WORK_DIR\periodic_${timestamp}.png"
                  & $env:NIRCMD_PATH savescreenshot full $screenshotPath
                  Write-Host "Periodic screenshot taken: $screenshotPath"
              }
              
              $screenshotCounter++
              Start-Sleep -Seconds 180  # Check every 3 minutes
          }
          
          Write-Host "24-hour limit reached, workflow completed"
