name: RustDesk with Screen Recording Permission

on:
  workflow_dispatch:

jobs:
  rustdesk-screenshots:
    runs-on: macos-latest
    timeout-minutes: 45  # 25 minutes for workflow + 20 minutes runtime

    steps:
      - name: Install RustDesk via Homebrew
        run: |
          echo "=== Installing RustDesk via Homebrew ==="
          
          # Install Homebrew if not present
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zshrc
            eval "$(/opt/homebrew/bin/brew shellenv)"
          fi
          
          # Install RustDesk
          brew install --cask rustdesk
          echo "âœ… RustDesk installed via Homebrew"

      - name: Get Exact Display Resolution
        run: |
          echo "=== Getting Exact Display Resolution ==="
          
          # Use AppleScript to get exact screen bounds
          RESOLUTION=$(osascript -e 'tell application "Finder" to get bounds of window of desktop' 2>/dev/null | awk '{print $3 "x" $4}')
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ]; then
            # Fallback method using system_profiler
            RESOLUTION=$(system_profiler SPDisplaysDataType 2>/dev/null | grep "UI Looks like" | head -1 | sed 's/.*UI Looks like: //' | sed 's/ //g')
          fi
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ]; then
            # Get from display settings
            RESOLUTION=$(system_profiler SPDisplaysDataType 2>/dev/null | grep "Resolution" | head -1 | sed 's/.*Resolution: //' | sed 's/ //g')
          fi
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ]; then
            echo "âš ï¸ Could not detect resolution, using 1024x768 as default"
            RESOLUTION="1024x768"
          fi
          
          echo "Detected resolution: $RESOLUTION"
          
          # Parse width and height
          WIDTH=$(echo $RESOLUTION | cut -d'x' -f1)
          HEIGHT=$(echo $RESOLUTION | cut -d'x' -f2)
          
          echo "Width: $WIDTH px"
          echo "Height: $HEIGHT px"
          
          # Save to environment
          echo "RESOLUTION=$RESOLUTION" >> $GITHUB_ENV
          echo "SCREEN_WIDTH=$WIDTH" >> $GITHUB_ENV
          echo "SCREEN_HEIGHT=$HEIGHT" >> $GITHUB_ENV
          
          # Create screenshots directory
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Start RustDesk and Wait for Permission Prompt
        run: |
          echo "=== Starting RustDesk ==="
          
          # Launch RustDesk
          open -a /Applications/RustDesk.app
          
          echo "Waiting for RustDesk to start and permission prompt to appear..."
          echo "This may take 10-15 seconds..."
          
          # Wait for RustDesk process
          for i in {1..30}; do
            if pgrep -f "RustDesk" > /dev/null; then
              echo "âœ… RustDesk process found (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Additional wait for permission dialog
          sleep 10
          
          echo "RustDesk should be running now"
          echo "Permission prompt should appear shortly..."

      - name: Take Initial Screenshot (Before Click)
        run: |
          echo "=== Taking Initial Screenshot (Before Permission Grant) ==="
          
          timestamp=$(date +%Y%m%d_%H%M%S)
          before_file="$SCREENSHOT_DIR/before_permission_$timestamp.png"
          
          screencapture -x "$before_file"
          
          if [ -f "$before_file" ]; then
            filesize=$(ls -lh "$before_file" | awk '{print $5}')
            echo "âœ… Initial screenshot saved: $before_file ($filesize)"
          else
            echo "âš ï¸ Failed to take initial screenshot"
          fi

      - name: Calculate Button Position Based on Resolution
        run: |
          echo "=== Calculating Button Position ==="
          
          # Original coordinates from 1024x768
          ORIGINAL_X=462
          ORIGINAL_Y=374
          ORIGINAL_WIDTH=1024
          ORIGINAL_HEIGHT=768
          
          # Calculate scaling factors
          X_SCALE=$(echo "scale=4; $SCREEN_WIDTH / $ORIGINAL_WIDTH" | bc)
          Y_SCALE=$(echo "scale=4; $SCREEN_HEIGHT / $ORIGINAL_HEIGHT" | bc)
          
          # Calculate new coordinates
          NEW_X=$(echo "$ORIGINAL_X * $X_SCALE" | bc | awk '{print int($1+0.5)}')
          NEW_Y=$(echo "$ORIGINAL_Y * $Y_SCALE" | bc | awk '{print int($1+0.5)}')
          
          echo "Original resolution: ${ORIGINAL_WIDTH}x${ORIGINAL_HEIGHT}"
          echo "Current resolution: ${SCREEN_WIDTH}x${SCREEN_HEIGHT}"
          echo "Scaling factors: X=${X_SCALE}, Y=${Y_SCALE}"
          echo "Original button position: (${ORIGINAL_X}, ${ORIGINAL_Y})"
          echo "Calculated button position: (${NEW_X}, ${NEW_Y})"
          
          # Save to environment
          echo "BUTTON_X=$NEW_X" >> $GITHUB_ENV
          echo "BUTTON_Y=$NEW_Y" >> $GITHUB_ENV

      - name: Click Allow Button and Grant Permissions
        run: |
          echo "=== Clicking Allow Button ==="
          echo "Clicking at coordinates: ($BUTTON_X, $BUTTON_Y)"
          
          # Install cliclick for precise clicking if not available
          if ! command -v cliclick &> /dev/null; then
            echo "Installing cliclick..."
            brew install cliclick
          fi
          
          # Click the Allow button
          echo "Attempting to click the button..."
          cliclick c:$BUTTON_X,$BUTTON_Y
          
          echo "âœ… Click performed"
          
          # Wait a moment for the dialog to close
          sleep 3
          
          # Also try using AppleScript as backup
          echo "Trying AppleScript click as backup..."
          osascript <<EOF
          tell application "System Events"
            -- Try to find and click the Allow button
            try
              click at {$BUTTON_X, $BUTTON_Y}
            end try
          end tell
          EOF
          
          # Additional permission granting commands
          echo "Granting screen recording permission via tccutil..."
          sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenRecording','com.carriez.rustdesk',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,UNIXEPOCH());" 2>/dev/null || true
          
          # Also try to grant via privacy preferences
          echo "Attempting to grant via privacy preferences..."
          osascript <<'END'
          tell application "System Preferences"
            activate
            reveal anchor "Privacy_Accessibility" of pane id "com.apple.preference.security"
          end tell
          
          tell application "System Events"
            tell process "System Preferences"
              repeat until window "Security & Privacy" exists
                delay 0.5
              end repeat
              
              -- Try to find and check RustDesk
              tell table 1 of scroll area 1 of window "Security & Privacy"
                select row 1
              end tell
            end tell
          end tell
          END

      - name: Take Debug Screenshot After Click
        run: |
          echo "=== Taking Debug Screenshot (After Permission Grant) ==="
          
          timestamp=$(date +%Y%m%d_%H%M%S)
          after_file="$SCREENSHOT_DIR/after_permission_$timestamp.png"
          
          screencapture -x "$after_file"
          
          if [ -f "$after_file" ]; then
            filesize=$(ls -lh "$after_file" | awk '{print $5}')
            echo "âœ… Debug screenshot saved: $after_file ($filesize)"
            
            # Get dimensions
            if command -v sips &> /dev/null; then
              width=$(sips -g pixelWidth "$after_file" | tail -1 | awk '{print $2}')
              height=$(sips -g pixelHeight "$after_file" | tail -1 | awk '{print $2}')
              echo "   Dimensions: ${width}x${height}"
            fi
          else
            echo "âš ï¸ Failed to take debug screenshot"
          fi
          
          # Wait a moment for RustDesk to initialize
          sleep 5

      - name: Take 5 Verification Screenshots
        run: |
          echo "=== Taking 5 Verification Screenshots ==="
          echo "Resolution: $RESOLUTION"
          
          for i in {1..5}; do
            echo ""
            echo "ðŸ“¸ Taking verification screenshot $i/5..."
            
            timestamp=$(date +%Y%m%d_%H%M%S)
            filepath="$SCREENSHOT_DIR/verification_${i}_${timestamp}.png"
            
            # Take screenshot
            screencapture -x "$filepath"
            
            if [ -f "$filepath" ]; then
              filesize=$(ls -lh "$filepath" | awk '{print $5}')
              echo "âœ… Saved: $(basename $filepath) ($filesize)"
              
              # Check if RustDesk window is visible (simplistic check)
              echo "   Checking if RustDesk is visible..."
            fi
            
            if [ $i -lt 5 ]; then
              echo "   Waiting 3 seconds..."
              sleep 3
            fi
          done
          
          # List all screenshots
          echo ""
          echo "=== All Screenshots Taken ==="
          ls -la "$SCREENSHOT_DIR/" 2>/dev/null | head -20

      - name: Upload All Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-permission-screenshots
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Verify RustDesk is Working
        run: |
          echo "=== Verifying RustDesk Status ==="
          
          # Check if RustDesk is running
          if pgrep -f "RustDesk" > /dev/null; then
            echo "âœ… RustDesk process is running"
            
            # Try to get RustDesk ID (may be in logs or window title)
            echo "Checking for RustDesk ID..."
            
            # Look for RustDesk window
            osascript <<'EOF' 2>/dev/null || true
            tell application "System Events"
              tell process "RustDesk"
                set windowName to name of front window
                display dialog "RustDesk Window: " & windowName
              end tell
            end tell
            EOF
            
          else
            echo "âŒ RustDesk is not running, attempting to restart..."
            open -a /Applications/RustDesk.app
            sleep 10
          fi
          
          # Check screen recording permission
          echo ""
          echo "=== Checking Screen Recording Permission ==="
          sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "SELECT * FROM access WHERE client='com.carriez.rustdesk';" 2>/dev/null || echo "Could not check TCC database"
          
          echo ""
          echo "âœ… Verification complete"

      - name: Keep System Running for 20 Minutes
        run: |
          echo "=== Keeping System Running for 20 Minutes ==="
          echo "Start time: $(date)"
          echo "End time will be: $(date -v+20M)"
          echo ""
          echo "RustDesk should now be fully functional with screen recording permission"
          echo "Screenshots have been uploaded as artifacts"
          echo ""
          echo "=== Starting 20-Minute Runtime ==="
          
          # Create a status file
          STATUS_FILE="$HOME/rustdesk_status.txt"
          echo "RustDesk Monitoring Log" > "$STATUS_FILE"
          echo "=======================" >> "$STATUS_FILE"
          echo "Start: $(date)" >> "$STATUS_FILE"
          echo "Resolution: $RESOLUTION" >> "$STATUS_FILE"
          echo "" >> "$STATUS_FILE"
          
          # Monitor for 20 minutes
          for minute in {1..20}; do
            current_time=$(date '+%H:%M:%S')
            echo "[$current_time] Minute $minute/20"
            echo "[$current_time] Minute $minute/20" >> "$STATUS_FILE"
            
            # Check RustDesk status
            if pgrep -f "RustDesk" > /dev/null; then
              echo "  âœ… RustDesk: Running"
              echo "  RustDesk: Running" >> "$STATUS_FILE"
              
              # Take periodic screenshot every 5 minutes
              if [ $((minute % 5)) -eq 0 ]; then
                periodic_file="$SCREENSHOT_DIR/runtime_minute_${minute}_$(date +%H%M%S).png"
                screencapture -x "$periodic_file" 2>/dev/null && echo "  ðŸ“¸ Runtime screenshot taken" || echo "  âš ï¸ Could not take runtime screenshot"
                echo "  Screenshot taken at minute $minute" >> "$STATUS_FILE"
              fi
            else
              echo "  âš ï¸ RustDesk: Not running, restarting..."
              echo "  RustDesk restarted at minute $minute" >> "$STATUS_FILE"
              open -a /Applications/RustDesk.app 2>/dev/null || true
            fi
            
            # Wait 1 minute
            echo "  Waiting 1 minute..."
            echo "" >> "$STATUS_FILE"
            sleep 60
          done
          
          echo ""
          echo "âœ… 20-minute runtime completed at $(date)"
          echo "End: $(date)" >> "$STATUS_FILE"
          
          # Upload status file
          echo "=== Uploading Status Log ==="
          cp "$STATUS_FILE" "$SCREENSHOT_DIR/rustdesk_status_log.txt"

      - name: Upload Final Status Log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rustdesk-status-log
          path: |
            ${{ env.SCREENSHOT_DIR }}/rustdesk_status_log.txt
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Final Cleanup
        if: always()
        run: |
          echo "=== Final Cleanup ==="
          
          # Take one final screenshot
          final_file="$SCREENSHOT_DIR/final_$(date +%H%M%S).png"
          screencapture -x "$final_file" 2>/dev/null && echo "âœ… Final screenshot taken" || echo "âš ï¸ Could not take final screenshot"
          
          # Stop RustDesk
          pkill -f "RustDesk" 2>/dev/null || true
          sleep 2
          
          echo "âœ… Cleanup complete"
          echo "Total runtime: ~25 minutes"
          echo "Total screenshots: $(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l)"
