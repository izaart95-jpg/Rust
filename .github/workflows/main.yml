name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec-login:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec-login"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Take initial screenshot
        run: |
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\initial.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          Write-Host "Initial screenshot saved"

      - name: Start Parsec UI
        run: |
          Write-Host "Starting Parsec UI..."
          $parsecPaths = @(
              "C:\Program Files\Parsec\parsecd.exe",
              "$env:LOCALAPPDATA\Parsec\parsecd.exe",
              "$env:APPDATA\Parsec\parsecd.exe"
          )
          
          foreach ($path in $parsecPaths) {
              if (Test-Path $path) {
                  Start-Process -FilePath $path
                  Write-Host "Started Parsec from: $path"
                  break
              }
          }
          Start-Sleep -Seconds 5

      - name: Take screenshot of login screen
        run: |
          Write-Host "Taking screenshot of login screen..."
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\login_screen.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Create and run AutoHotkey script
        run: |
          # Create the AHK script file
          $ahkScript = @"
#NoEnv
SendMode Input
SetWorkingDir %A_ScriptDir%

; Wait for Parsec window
WinWait, Parsec, , 30
if ErrorLevel
{
    ExitApp
}

; Activate Parsec window
WinActivate, Parsec
WinWaitActive, Parsec, , 5
Sleep, 1000

; Take screenshot before login attempt
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\before_login.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

; Try to click on email field
Sleep, 2000
Click, 500, 300

; Type email
Send, ffbewafa709@gmail.com
Sleep, 1000

; Tab to password field
Send, {Tab}
Sleep, 500

; Type password
Send, Hamza@123456
Sleep, 1000

; Take screenshot with credentials entered
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\credentials_entered.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

; Click login button
Sleep, 1000
Click, 500, 400

; Wait and take final screenshot
Sleep, 5000
Run, powershell -Command "Add-Type -AssemblyName System.Windows.Forms; Add-Type -AssemblyName System.Drawing; `$screen = [System.Windows.Forms.Screen]::PrimaryScreen; `$bounds = `$screen.Bounds; `$bitmap = New-Object System.Drawing.Bitmap(`$bounds.Width, `$bounds.Height); `$graphics = [System.Drawing.Graphics]::FromImage(`$bitmap); `$graphics.CopyFromScreen(`$bounds.Location, [System.Drawing.Point]::Empty, `$bounds.Size); `$bitmap.Save('$env:WORK_DIR\after_login_click.png', [System.Drawing.Imaging.ImageFormat]::Png); `$graphics.Dispose(); `$bitmap.Dispose()"

Sleep, 3000
"@
          
          $ahkPath = "$env:WORK_DIR\login.ahk"
          $ahkScript | Out-File -FilePath $ahkPath -Encoding UTF8
          Write-Host "AHK script created"

      - name: Install AutoHotkey
        run: |
          Write-Host "Downloading AutoHotkey..."
          $ahkInstaller = "$env:WORK_DIR\AutoHotkey.exe"
          Invoke-WebRequest -Uri "https://www.autohotkey.com/download/ahk-install.exe" -OutFile $ahkInstaller
          
          Write-Host "Installing AutoHotkey..."
          Start-Process -FilePath $ahkInstaller -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 5

      - name: Run AutoHotkey script
        run: |
          Write-Host "Running AutoHotkey script..."
          $ahkExe = "C:\Program Files\AutoHotkey\AutoHotkey.exe"
          if (Test-Path $ahkExe) {
              Start-Process -FilePath $ahkExe -ArgumentList "$env:WORK_DIR\login.ahk"
              Start-Sleep -Seconds 20
          }

      - name: Wait for 2FA
        run: |
          Write-Host "Waiting 90 seconds for 2FA..."
          Start-Sleep -Seconds 90
          
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\after_2fa_wait.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Try to click Share button
        run: |
          Write-Host "Trying to click Share button..."
          
          # Create simple click script
          $clickScript = @"
#NoEnv
SendMode Input
SetWorkingDir %A_ScriptDir%

Sleep, 3000

; Try multiple positions
Click, 700, 100
Sleep, 1000
Click, 700, 300
Sleep, 1000
Click, 700, 500
Sleep, 1000
"@
          
          $clickPath = "$env:WORK_DIR\click.ahk"
          $clickScript | Out-File -FilePath $clickPath -Encoding UTF8
          
          $ahkExe = "C:\Program Files\AutoHotkey\AutoHotkey.exe"
          if (Test-Path $ahkExe) {
              Start-Process -FilePath $ahkExe -ArgumentList $clickPath
              Start-Sleep -Seconds 10
          }
          
          # Take screenshot after clicks
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\after_clicks.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Take final screenshots
        run: |
          Write-Host "Taking final screenshots..."
          for ($i = 1; $i -le 5; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              $bitmap.Save("$env:WORK_DIR\final_$i.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              Start-Sleep -Seconds 1
          }

      - name: Verify files
        run: |
          Write-Host "Files in $env:WORK_DIR:"
          Get-ChildItem -Path $env:WORK_DIR | Format-Table -AutoSize

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: parsec-screenshots
          path: D:\a\SEB\SEB\parsec-login\*.png
          retention-days: 1
