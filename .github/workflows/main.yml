name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Download nircmd
        run: |
          Write-Host "Downloading nircmd..."
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd.zip"
          $zipPath = "$env:TEMP\nircmd.zip"
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath "$env:TEMP\nircmd_extract" -Force
          $nircmdExe = Get-ChildItem -Path "$env:TEMP\nircmd_extract" -Filter "nircmd.exe" -Recurse | Select-Object -First 1
          if ($nircmdExe) {
              Copy-Item -Path $nircmdExe.FullName -Destination "$env:WORK_DIR\nircmd.exe" -Force
              Write-Host "nircmd downloaded successfully"
          }

      - name: Download and install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec silently..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Start Parsec
        run: |
          Write-Host "Starting Parsec..."
          
          # Start Parsec
          $parsecExePath = "C:\Program Files\Parsec\parsecd.exe"
          if (Test-Path $parsecExePath) {
              Start-Process $parsecExePath
              Write-Host "Parsec started..."
          }
          
          Start-Sleep -Seconds 10

      - name: THE CORRECT SOLUTION - Use 90 pixel offset
        run: |
          Write-Host "=== THE CORRECT SOLUTION ==="
          Write-Host "WE FOUND THE ANSWER: Password field is 90 pixels below email field!"
          Write-Host "At offset 90, we saw cursor | in password field (box was small)")
          Write-Host "Now we will:"
          Write-Host "1. Click email field"
          Write-Host "2. Type email"
          Write-Host "3. Click 90 pixels BELOW (password field)"
          Write-Host "4. Type password"
          Write-Host "5. Click login button"
          
          # Get screen dimensions
          Add-Type -AssemblyName System.Windows.Forms
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $width = $screen.Bounds.Width
          $height = $screen.Bounds.Height
          $centerX = [math]::Round($width / 2)
          
          Write-Host "Screen: ${width}x${height}"
          Write-Host "Center X: $centerX"
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              # STEP 1: Find and click email field
              Write-Host "=== STEP 1: EMAIL FIELD ==="
              
              # Email field is around 35% from top based on previous tests
              $emailY = [math]::Round($height * 0.35)
              Write-Host "Clicking EMAIL field at: $centerX, $emailY")
              
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $emailY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # Type email
              Add-Type -AssemblyName System.Windows.Forms
              Write-Host "Typing email: ffbewafa709@gmail.com")
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
              Start-Sleep -Seconds 2
              
              # Screenshot after email
              Add-Type -AssemblyName System.Drawing
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\1_email_done.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # STEP 2: Click password field (90 pixels BELOW email click)
              Write-Host "=== STEP 2: PASSWORD FIELD ==="
              Write-Host "CRITICAL: Clicking 90 pixels BELOW email position")
              
              $passwordY = $emailY + 90  # 90 PIXELS BELOW EMAIL!
              Write-Host "Clicking PASSWORD field at: $centerX, $passwordY")
              
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $passwordY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # Type password
              Write-Host "Typing password: Hamza@123456")
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
              Start-Sleep -Seconds 2
              
              # Screenshot after password
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\2_password_done.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # STEP 3: Click login button (another 50-60 pixels below password)
              Write-Host "=== STEP 3: LOGIN BUTTON ==="
              
              $loginY = $passwordY + 60  # 60 pixels below password field
              Write-Host "Clicking LOGIN button at: $centerX, $loginY")
              
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $loginY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              Start-Sleep -Seconds 3
              
              Write-Host "Login sequence completed!")
              
              # Also try pressing Enter as backup
              Write-Host "Also trying Enter key as backup...")
              [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
              Start-Sleep -Seconds 2
          }

      - name: Verify with different offsets near 90
        run: |
          Write-Host "=== VERIFICATION: TRY OFFSETS NEAR 90 ==="
          Start-Sleep -Seconds 5
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $width = $screen.Bounds.Width
              $height = $screen.Bounds.Height
              $centerX = [math]::Round($width / 2)
              
              # Try offsets around 90 to be sure
              $offsets = @(85, 90, 95, 100)
              
              foreach ($offset in $offsets) {
                  Write-Host "--- Testing offset $offset ---")
                  
                  # Click email
                  $emailY = [math]::Round($height * 0.35)
                  & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $emailY
                  Start-Sleep -Milliseconds 300
                  & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
                  Start-Sleep -Seconds 1
                  [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}ffbewafa709@gmail.com")
                  Start-Sleep -Seconds 1
                  
                  # Click password with current offset
                  $passwordY = $emailY + $offset
                  & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $passwordY
                  Start-Sleep -Milliseconds 300
                  & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
                  Start-Sleep -Seconds 1
                  [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}Hamza@123456")
                  Start-Sleep -Seconds 1
                  
                  # Click login
                  $loginY = $passwordY + 60
                  & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $loginY
                  Start-Sleep -Milliseconds 300
                  & "$env:WORK_DIR\nircmd.exe" sendmouse left click
                  Start-Sleep -Seconds 2
                  
                  # Screenshot
                  $bitmap = New-Object System.Drawing.Bitmap($width, $height)
                  $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
                  $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
                  $bitmap.Save("$env:WORK_DIR\offset_${offset}_result.png", [System.Drawing.Imaging.ImageFormat]::Png)
                  $graphics.Dispose()
                  $bitmap.Dispose()
                  
                  Write-Host "Offset $offset test completed")
                  Start-Sleep -Seconds 2
              }
          }

      - name: Alternative Tab method with our knowledge
        run: |
          Write-Host "=== ALTERNATIVE: TAB METHOD ==="
          Start-Sleep -Seconds 5
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Add-Type -AssemblyName System.Windows.Forms
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $width = $screen.Bounds.Width
              $height = $screen.Bounds.Height
              $centerX = [math]::Round($width / 2)
              
              # Focus window
              $focusY = [math]::Round($height * 0.35)
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $focusY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              Start-Sleep -Seconds 1
              
              # Method A: Click email, then Tab to password
              Write-Host "Method A: Click email, Tab to password")
              
              # Click email field
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $focusY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # Type email
              [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
              Start-Sleep -Seconds 1
              
              # Press Tab ONCE to go to password field
              Write-Host "Pressing Tab to go to password field...")
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
              Start-Sleep -Seconds 1
              
              # Type password
              [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
              Start-Sleep -Seconds 1
              
              # Press Tab then Enter for login
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
              Start-Sleep -Seconds 2
              
              # Method B: Try multiple Tabs from start
              Write-Host "Method B: Try multiple Tabs from start")
              Start-Sleep -Seconds 3
              
              # Press Tab 3 times to cycle through fields
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}{TAB}{TAB}")
              Start-Sleep -Seconds 1
              
              # Should be in email field - type email
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}ffbewafa709@gmail.com")
              Start-Sleep -Seconds 1
              
              # Tab to password
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
              Start-Sleep -Seconds 1
              [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
              Start-Sleep -Seconds 1
              
              # Tab to login and press Enter
              [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
          }

      - name: Take final verification
        run: |
          Write-Host "=== FINAL VERIFICATION ==="
          Start-Sleep -Seconds 8
          
          # Take final screenshots
          for ($i = 1; $i -le 5; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              
              $fileName = "final_check_$i.png"
              $bitmap.Save("$env:WORK_DIR\$fileName", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              Write-Host "Final screenshot $i taken"
              Start-Sleep -Seconds 1
          }
          
          # Check Parsec
          $parsecProcess = Get-Process | Where-Object { $_.ProcessName -like "*parsec*" }
          Write-Host "=== PARSEC STATUS ==="
          if ($parsecProcess) {
              Write-Host "✓ Parsec is running"
              $parsecProcess | Format-Table ProcessName, Id, MainWindowTitle -AutoSize
              
              # Look for signs of successful login
              $hasMainWindow = $parsecProcess | Where-Object { $_.MainWindowTitle -notlike "*Sign*" -and $_.MainWindowTitle -ne "" }
              if ($hasMainWindow) {
                  Write-Host "✓ SUCCESS: Parsec appears to be logged in!"
                  Write-Host "Window title: $($hasMainWindow.MainWindowTitle)")
              } else {
                  Write-Host "? Parsec running but may still be on login screen")
              }
          } else {
              Write-Host "✗ Parsec is NOT running")
          }

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: parsec-results
          path: D:\a\SEB\SEB\parsec\
          retention-days: 1
